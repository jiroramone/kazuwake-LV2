<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‹ãšã‚ã‘ã‚²ãƒ¼ãƒ ï¼ˆã‚„ã•ã—ã„ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ã‹ãšã‚ã‘ã‚²ãƒ¼ãƒ ï¼ˆã‚„ã•ã—ã„ç‰ˆï¼‰</h1>
  <div id="question">å•é¡Œ</div>

  <div id="drop-container">
    <div class="drop-zone" id="slot1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <span id="plus">ã¨</span>
    <div class="drop-zone" id="slot2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
  </div>

  <div id="cards"></div>
  <div id="result"></div>

<script>
  const allTargets = [3,4,5,6,7,8,9,10];
  let targets = [];
  let currentIndex = 0;
  let currentTarget = null;
  const usedPairs = new Set();
  let touchedCard = null;

  function shuffleArray(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function createCard(n) {
    const div = document.createElement('div');
    div.className = 'card';
    div.dataset.value = n;

    let dotsHtml = '';

    if (n <= 5) {
      dotsHtml = `<span class="dots-row">${'â—'.repeat(n)}</span>`;
    } else {
      let topCount, bottomCount;
      switch (n) {
        case 6: topCount=3; bottomCount=3; break;
        case 7: topCount=4; bottomCount=3; break;
        case 8: topCount=4; bottomCount=4; break;
        case 9: topCount=5; bottomCount=4; break;
        case 10: topCount=5; bottomCount=5; break;
        default:
          topCount = Math.ceil(n/2);
          bottomCount = n - topCount;
      }
      dotsHtml =
        `<span class="dots-row">${'â—'.repeat(topCount)}</span>` +
        `<span class="dots-row">${'â—'.repeat(bottomCount)}</span>`;
    }

    div.innerHTML = `<strong>${n}</strong><span class="dots">${dotsHtml}</span>`;
    div.setAttribute('draggable', true);

    div.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData("text", n);
    });

    div.addEventListener('touchstart', touchStart, false);
    div.addEventListener('touchmove', touchMove, false);
    div.addEventListener('touchend', touchEnd, false);

    return div;
  }

  function setupCards(target) {
    const cardArea = document.getElementById('cards');
    cardArea.innerHTML = '';
    for (let i = 0; i <= target; i++) {
      const card = createCard(i);
      cardArea.appendChild(card);
    }
  }

  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drop(ev) {
    ev.preventDefault();
    const n = parseInt(ev.dataTransfer.getData("text"));
    const card = createCard(n);
    const dropZone = ev.target;
    if (dropZone.classList.contains("drop-zone")) {
      dropZone.innerHTML = '';
      dropZone.appendChild(card);
      checkAnswer();
    }
  }

  function resetSlots() {
    document.getElementById("slot1").innerHTML = '';
    document.getElementById("slot2").innerHTML = '';
  }

  function updateQuestion() {
    if (currentIndex >= targets.length) {
      updateResult("ğŸ‰ ã™ã¹ã¦ã®ã‚‚ã‚“ã ã„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ãŠã‚ã§ã¨ã†ï¼");
      document.getElementById('question').textContent = "ãŠã—ã¾ã„";
      resetSlots();
      document.getElementById('cards').innerHTML = '';
      return;
    }
    currentTarget = targets[currentIndex];
    document.getElementById('question').textContent = `${currentTarget} ã¯ ã„ãã¤ ã¨ ã„ãã¤ï¼Ÿ`;
    resetSlots();
    setupCards(currentTarget);
    usedPairs.clear();
    updateResult('');
  }

  function updateResult(text, showCircle=false) {
    const result = document.getElementById('result');
    if (showCircle) {
      result.innerHTML = `<img src="hanamaru.png" alt="èŠ±ä¸¸" class="big-circle"><div>${text.replace(/\n/g, '<br>')}</div>`;
    } else {
      result.textContent = text;
    }
  }

  function checkAnswer() {
    const slot1 = document.getElementById("slot1").firstElementChild;
    const slot2 = document.getElementById("slot2").firstElementChild;
    if (!slot1 || !slot2) return;

    const a = parseInt(slot1.dataset.value);
    const b = parseInt(slot2.dataset.value);

    if (a + b === currentTarget) {
      const key = [a, b].sort((x, y) => x - y).join(',');
      if (!usedPairs.has(key)) {
        usedPairs.add(key);
        const totalPairs = Math.floor(currentTarget / 2) + 1;
        const left = totalPairs - usedPairs.size;
        let message = `ã›ã„ã‹ã„ï¼ ${a} ã¨ ${b} ã§ ${currentTarget} ã«ãªã‚‹ã‚ˆï¼\n`;
        message += `ã®ã“ã‚Šã®ãã¿ã‚ã‚ã›ï¼š${left}ã“`;
        updateResult(message, true);
        if (left === 0) {
          message += "\nãœã‚“ã¶ã® ãã¿ã‚ã‚ã›ãŒ ã¿ã¤ã‹ã£ãŸã‚ˆï¼ã¤ãã®ã‚‚ã‚“ã ã„ã¸ï¼";
          currentIndex++;
          setTimeout(() => {
            updateQuestion();
          }, 1000);
        }
        setTimeout(() => {
          resetSlots();
        }, 500);
      } else {
        updateResult("ãã® ãã¿ã‚ã‚ã›ã¯ ã‚‚ã† ã“ãŸãˆãŸã‚ˆã€‚");
        setTimeout(() => {
          resetSlots();
        }, 500);
      }
    } else {
      updateResult("ã¡ãŒã†ã‚ˆã€‚ã‚‚ã† ã„ã¡ã©ï¼");
      setTimeout(() => {
        resetSlots();
      }, 500);
    }
  }

  function touchStart(e) {
    touchedCard = e.currentTarget;
  }

  function touchMove(e) {
    e.preventDefault();
  }

  function touchEnd(e) {
    const touch = e.changedTouches[0];
    const elem = document.elementFromPoint(touch.clientX, touch.clientY);
    if (elem && elem.classList.contains('drop-zone')) {
      const n = parseInt(touchedCard.dataset.value);
      const card = createCard(n);
      elem.innerHTML = '';
      elem.appendChild(card);
      checkAnswer();
    }
    touchedCard = null;
  }

  function startGame() {
    targets = allTargets.slice();
    shuffleArray(targets);
    currentIndex = 0;
    updateQuestion();
  }

  startGame();

</script>
</body>
</html>
